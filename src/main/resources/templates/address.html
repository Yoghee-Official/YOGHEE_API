<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주소 검색</title>
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #layer {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
<div id="layer"></div>

<script>
  // 페이지 로드시 바로 주소 검색 팝업 실행
  window.onload = function () {
    new daum.Postcode({
      oncomplete: function (data) {
        let address = data.address;
        let fullAddress = address;

        // 도로명 주소인 경우 추가 정보 포함
        if (data.addressType === 'R') {
          if (data.bname !== '') {
            fullAddress += ' (' + data.bname + ')';
          }
          if (data.buildingName !== '') {
            fullAddress += ', ' + data.buildingName;
          }
        }

        // 선택된 주소 정보를 콘솔에 출력 (개발용)
        console.log('선택된 주소:', fullAddress);
        console.log('우편번호:', data.zonecode);

        // 주소 선택 완료 시 처리
        const addressData = {
          address: fullAddress,
          zonecode: data.zonecode,
          roadAddress: data.roadAddress,
          jibunAddress: data.jibunAddress,
          buildingCode: data.buildingCode,
          latitude: data.y || null,
          longitude: data.x || null
        };

        // 1. 모바일 웹뷰에서 JavaScript 인터페이스 사용 (Android/iOS)
        try {
          // Android WebView JavaScript Interface
          if (window.Android && window.Android.onAddressSelected) {
            window.Android.onAddressSelected(JSON.stringify(addressData));
            return;
          }

          // iOS WKWebView JavaScript Interface
          if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.addressHandler) {
            window.webkit.messageHandlers.addressHandler.postMessage(addressData);
            return;
          }
        } catch (e) {
          console.log('Mobile interface not available:', e);
        }

        // 2. PostMessage API 사용 (React Native WebView 등)
        try {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'ADDRESS_SELECTED',
              data: addressData
            }));
            return;
          }

          // 일반적인 PostMessage (부모 창으로)
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'ADDRESS_SELECTED',
              data: addressData
            }, '*');
            return;
          }
        } catch (e) {
          console.log('PostMessage not available:', e);
        }

        // 3. 웹 브라우저에서 팝업으로 사용하는 경우
        if (window.opener && window.opener.setAddress) {
          window.opener.setAddress(fullAddress);
          window.close();
          return;
        }

        // 4. 독립적으로 사용하는 경우 - URL 파라미터로 리다이렉트
        const params = new URLSearchParams({
          address: fullAddress,
          zonecode: data.zonecode,
          roadAddress: data.roadAddress || '',
          jibunAddress: data.jibunAddress || ''
        });

        // 콜백 URL이 있으면 해당 URL로, 없으면 alert
        const callbackUrl = new URLSearchParams(window.location.search).get('callback');
        if (callbackUrl) {
          window.location.href = callbackUrl + '?' + params.toString();
        } else {
          alert('선택된 주소: ' + fullAddress + '\n우편번호: ' + data.zonecode + '\n도로명주소 : ' + data.roadAddress + '\n지번주소 : ' + data.jibunAddress);
        }
      },
      onclose: function (state) {
        console.log('주소 검색 팝업 닫힘:', state);

        // 모바일 웹뷰에서 취소 알림
        try {
          // Android WebView
          if (window.Android && window.Android.onAddressCancelled) {
            window.Android.onAddressCancelled();
            return;
          }

          // iOS WKWebView
          if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.addressHandler) {
            window.webkit.messageHandlers.addressHandler.postMessage({cancelled: true});
            return;
          }

          // React Native WebView
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'ADDRESS_CANCELLED'
            }));
            return;
          }

          // PostMessage to parent
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'ADDRESS_CANCELLED'
            }, '*');
            return;
          }
        } catch (e) {
          console.log('Mobile cancel notification failed:', e);
        }

        // 웹 브라우저 팝업인 경우 창 닫기
        if (window.opener) {
          window.close();
        }
      },
      width: '100%',
      height: '100%'
    }).embed(document.getElementById('layer'));
  };
</script>
</body>
</html>